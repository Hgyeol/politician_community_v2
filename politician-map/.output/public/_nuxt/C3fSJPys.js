import{_ as re}from"./DA1Fcrqp.js";import{r as b,X as ne,h as ae,G as le,m as ie,H as X,i as de,c as a,g as D,a as e,t as m,u as f,b as J,w as P,y as N,z as V,F as I,v as Q,o as l,d as W}from"./CmVufc-E.js";import{u as ue}from"./DivXWrku.js";import{u as ce}from"./gLgMcFAZ.js";import{u as me}from"./DP_pfCD1.js";function ge(U){const _=me(),v=b([]),g=b(!1);return{comments:v,loading:g,loadComments:async()=>{g.value=!0;try{const{data:i,error:c}=await _.from("comments").select(`
          *,
          parent_id
        `).eq("suggestion_id",U).order("created_at",{ascending:!0});if(c)throw c;if(!i)return v.value=[],{data:[],error:null};const d=[...new Set(i.map(u=>u.user_id))],{data:w,error:y}=await _.from("profiles").select("id, nickname").in("id",d);y&&console.error("Failed to fetch profiles for comments:",y);const n=new Map(w?.map(u=>[u.id,u])),p=i.map(u=>({...u,profiles:n.get(u.user_id)||null}));return v.value=p,{data:p,error:null}}catch(i){return console.error("Failed to load comments:",i),{data:null,error:i.message}}finally{g.value=!1}},createComment:async(i,c=null)=>{try{const d=ne();if(!d.value)throw new Error("로그인이 필요합니다");const w=d.value.id||d.value.sub,{data:y,error:n}=await _.from("comments").insert([{content:i,suggestion_id:U,user_id:w,parent_id:c}]).select("id").single();if(n)throw n;if(!y)throw new Error("Failed to get new comment ID");const{data:p,error:u}=await _.from("comments").select("*").eq("id",y.id).single();if(u)throw u;if(!p)throw new Error("Failed to fetch new comment data");const{data:x,error:C}=await _.from("profiles").select("id, nickname").eq("id",p.user_id).single();C&&console.error("Failed to fetch profile for new comment:",C);const E={...p,profiles:x||null};return v.value.push(E),{data:E,error:null}}catch(d){return console.error("Failed to create comment:",d),{data:null,error:d.message}}},updateComment:async(i,c)=>{try{const{data:d,error:w}=await _.from("comments").update({content:c}).eq("id",i).select("*").single();if(w)throw w;if(!d)throw new Error("Failed to update comment or get updated data");const{data:y,error:n}=await _.from("profiles").select("id, nickname").eq("id",d.user_id).single();n&&console.error("Failed to fetch profile for updated comment:",n);const p={...d,profiles:y||null},u=v.value.findIndex(x=>x.id===i);return u!==-1&&(v.value[u]=p),{data:p,error:null}}catch(d){return console.error("Failed to update comment:",d),{data:null,error:d.message}}},deleteComment:async i=>{try{const{error:c}=await _.from("comments").delete().eq("id",i);if(c)throw c;return v.value=v.value.filter(d=>d.id!==i),{error:null}}catch(c){return console.error("Failed to delete comment:",c),{error:c.message}}}}}const pe={class:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},fe={key:0,class:"text-center py-16"},ve={key:1,class:"text-center py-16"},be={class:"text-red-600 text-lg mb-4"},_e={key:2},ye={class:"mb-6"},xe={class:"flex items-center justify-between mb-4"},he={key:0,class:"flex gap-2"},we={class:"bg-white border border-gray-200 rounded-lg p-8 mb-6"},Ce={class:"mb-4"},ke={class:"px-3 py-1 bg-gray-50 text-gray-700 rounded-full text-sm font-medium"},Ee={class:"text-3xl font-bold text-gray-900 mb-6"},De={class:"flex items-center justify-between text-sm text-gray-500 mb-8 pb-6 border-b border-gray-200"},Fe={class:"flex items-center space-x-4"},$e={class:"font-medium text-gray-700"},Se={class:"flex items-center space-x-4"},Te={class:"prose max-w-none"},je={class:"text-gray-800 whitespace-pre-wrap leading-relaxed"},Ne={class:"bg-white border border-gray-200 rounded-lg p-8"},Ve={class:"text-2xl font-bold text-gray-900 mb-6"},Ie={key:0,class:"mb-8"},Ue={class:"flex justify-end"},qe=["disabled"],Me={key:1,class:"mb-8 p-4 bg-gray-50 rounded-lg text-center"},Re={class:"space-y-4"},ze={class:"flex justify-between items-start mb-2"},Le={class:"flex items-center space-x-3"},Be={class:"font-medium text-gray-900"},Ae={class:"text-sm text-gray-500"},Ge={class:"flex gap-2"},He=["onClick"],Ke=["onClick"],Oe=["onClick"],Xe={key:0},Je={class:"flex justify-end gap-2"},Pe=["onClick"],Qe={key:1,class:"text-gray-700 whitespace-pre-wrap"},We={key:2,class:"mt-4"},Ye={class:"flex justify-end gap-2"},Ze=["onClick","disabled"],et={key:0,class:"ml-8 mt-4 space-y-4 border-t border-gray-200 pt-4"},tt={class:"flex justify-between items-start mb-2"},ot={class:"flex items-center space-x-3"},st={class:"font-medium text-gray-900"},rt={class:"text-sm text-gray-500"},nt={class:"flex gap-2"},at=["onClick"],lt=["onClick"],it={key:0},dt={class:"flex justify-end gap-2"},ut=["onClick"],ct={key:1,class:"text-gray-700 whitespace-pre-wrap"},mt={key:1,class:"text-center py-8 text-gray-500"},_t=ae({__name:"[id]",setup(U){const _=le(),v=ie(),{user:g,isAuthenticated:S}=ue(),{getSuggestion:L,deleteSuggestion:B}=ce(),T=parseInt(_.params.id),{comments:i,loadComments:c,createComment:d,updateComment:w,deleteComment:y}=ge(T),n=b(null),p=b(!0),u=b(""),x=b(""),C=b(!1),E=b(null),k=b(""),q=b(null),F=b(""),A=b(null),Y=X(()=>{const s=g.value?.id||g.value?.sub;return g.value&&n.value&&s===n.value.user_id}),M=s=>s.profiles?.nickname||"익명",Z=X(()=>{const s=i.value.filter(o=>!o.parent_id),t=i.value.filter(o=>o.parent_id),h=new Map(i.value.map(o=>[o.id,{...o,replies:[]}]));return t.forEach(o=>{const r=h.get(o.parent_id);r&&r.replies.push(o)}),s.sort((o,r)=>new Date(o.created_at).getTime()-new Date(r.created_at).getTime()),h.forEach(o=>{o.replies&&o.replies.sort((r,$)=>new Date(r.created_at).getTime()-new Date($.created_at).getTime())}),s.map(o=>h.get(o.id))});de(async()=>{await ee(),await c()});async function ee(){p.value=!0,u.value="";const{data:s,error:t}=await L(T);t?u.value=t:n.value=s,p.value=!1}async function G(s=null){let t="";if(s===null?t=x.value:t=F.value,!t.trim()||C.value)return;C.value=!0;const{error:h}=await d(t,s);h?alert("댓글 작성에 실패했습니다: "+h):(s===null?x.value="":F.value="",R(),await c()),C.value=!1}function H(s){E.value=s.id,k.value=s.content,R()}function j(){E.value=null,k.value=""}function R(){q.value=null,F.value="",A.value=null}function te(s){q.value=s.id,A.value=M(s),j()}async function oe(){alert("수정 기능은 현재 준비 중입니다")}async function K(s){if(!k.value.trim())return;const{error:t}=await w(s,k.value);t?alert("댓글 수정에 실패했습니다: "+t):j()}async function O(s){if(!confirm("댓글을 삭제하시겠습니까?"))return;const{error:t}=await y(s);t?alert("댓글 삭제에 실패했습니다: "+t):await c()}async function se(){if(!confirm("건의사항을 삭제하시겠습니까?"))return;const{error:s}=await B(T);s?alert("삭제에 실패했습니다: "+s):v.push("/suggestions")}function z(s){return new Date(s).toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}return(s,t)=>{const h=re;return l(),a("div",pe,[p.value?(l(),a("div",fe,[...t[7]||(t[7]=[e("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-800"},null,-1)])])):u.value?(l(),a("div",ve,[e("p",be,m(u.value),1),e("button",{onClick:t[0]||(t[0]=o=>f(v).back()),class:"px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors"}," 돌아가기 ")])):n.value?(l(),a("div",_e,[e("div",ye,[e("div",xe,[e("button",{onClick:t[1]||(t[1]=o=>f(v).back()),class:"text-gray-600 hover:text-gray-900 font-medium"}," ← 목록으로 "),Y.value?(l(),a("div",he,[e("button",{onClick:oe,class:"px-4 py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors"}," 수정 "),e("button",{onClick:se,class:"px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors"}," 삭제 ")])):D("",!0)])]),e("div",we,[e("div",Ce,[e("span",ke,m(n.value.category),1)]),e("h1",Ee,m(n.value.title),1),e("div",De,[e("div",Fe,[e("span",$e,m(n.value.profiles?.nickname||"익명"),1),t[8]||(t[8]=e("span",null,"→",-1)),J(h,{to:`/politicians/${n.value.politician_id}/suggestions`,class:"font-medium text-gray-800 hover:text-blue-800"},{default:P(()=>[W(m(n.value.politicians?.name),1)]),_:1},8,["to"]),e("span",null,"("+m(n.value.politicians?.region)+")",1)]),e("div",Se,[e("span",null,"조회 "+m(n.value.view_count||0),1),e("span",null,m(z(n.value.created_at)),1)])]),e("div",Te,[e("p",je,m(n.value.content),1)])]),e("div",Ne,[e("h2",Ve," 댓글 "+m(f(i).length),1),f(S)?(l(),a("div",Ie,[N(e("textarea",{"onUpdate:modelValue":t[2]||(t[2]=o=>x.value=o),rows:"3",placeholder:"새 댓글을 작성하세요",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none mb-2"},null,512),[[V,x.value]]),e("div",Ue,[e("button",{onClick:t[3]||(t[3]=o=>G(null)),disabled:!x.value.trim()||C.value,class:"px-6 py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"}," 댓글 작성 ",8,qe)])])):(l(),a("div",Me,[t[10]||(t[10]=e("p",{class:"text-gray-600 mb-2"},"댓글을 작성하려면 로그인이 필요합니다",-1)),J(h,{to:"/auth/login",class:"text-gray-800 hover:text-blue-800 font-medium"},{default:P(()=>[...t[9]||(t[9]=[W(" 로그인하기 → ",-1)])]),_:1})])),e("div",Re,[f(i).length>0?(l(!0),a(I,{key:0},Q(Z.value,o=>(l(),a("div",{key:o.id,class:"border-b border-gray-200 pb-4 last:border-0"},[e("div",null,[e("div",null,[e("div",ze,[e("div",Le,[e("span",Be,m(M(o)),1),e("span",Ae,m(z(o.created_at)),1)]),e("div",Ge,[f(S)?(l(),a("button",{key:0,onClick:r=>te(o),class:"text-sm text-gray-600 hover:text-blue-700"}," 답글 ",8,He)):D("",!0),f(g)&&(f(g).id||f(g).sub)===o.user_id?(l(),a(I,{key:1},[e("button",{onClick:r=>H(o),class:"text-sm text-gray-800 hover:text-blue-800"}," 수정 ",8,Ke),e("button",{onClick:r=>O(o.id),class:"text-sm text-red-600 hover:text-red-800"}," 삭제 ",8,Oe)],64)):D("",!0)])]),E.value===o.id?(l(),a("div",Xe,[N(e("textarea",{"onUpdate:modelValue":t[4]||(t[4]=r=>k.value=r),rows:"3",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none mb-2"},null,512),[[V,k.value]]),e("div",Je,[e("button",{onClick:r=>K(o.id),class:"px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium hover:bg-gray-900"}," 저장 ",8,Pe),e("button",{onClick:j,class:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300"}," 취소 ")])])):(l(),a("p",Qe,m(o.content),1)),f(S)&&q.value===o.id?(l(),a("div",We,[N(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=r=>F.value=r),rows:"3",placeholder:"답글을 작성하세요",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none mb-2"},null,512),[[V,F.value]]),e("div",Ye,[e("button",{onClick:r=>G(o.id),disabled:!F.value.trim()||C.value,class:"px-6 py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"}," 답글 작성 ",8,Ze),e("button",{onClick:R,class:"px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300"}," 취소 ")])])):D("",!0)]),o.replies&&o.replies.length>0?(l(),a("div",et,[(l(!0),a(I,null,Q(o.replies,r=>(l(),a("div",{key:r.id},[e("div",tt,[e("div",ot,[e("span",st,m(M(r)),1),e("span",rt,m(z(r.created_at)),1)]),e("div",nt,[f(g)&&(f(g).id||f(g).sub)===r.user_id?(l(),a(I,{key:0},[e("button",{onClick:$=>H(r),class:"text-sm text-gray-800 hover:text-blue-800"}," 수정 ",8,at),e("button",{onClick:$=>O(r.id),class:"text-sm text-red-600 hover:text-red-800"}," 삭제 ",8,lt)],64)):D("",!0)])]),E.value===r.id?(l(),a("div",it,[N(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=$=>k.value=$),rows:"3",class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none mb-2"},null,512),[[V,k.value]]),e("div",dt,[e("button",{onClick:$=>K(r.id),class:"px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium hover:bg-gray-900"}," 저장 ",8,ut),e("button",{onClick:j,class:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300"}," 취소 ")])])):(l(),a("p",ct,m(r.content),1))]))),128))])):D("",!0)])]))),128)):(l(),a("div",mt," 아직 댓글이 없습니다. 첫 댓글을 작성해보세요! "))])])])):D("",!0)])}}});export{_t as default};
