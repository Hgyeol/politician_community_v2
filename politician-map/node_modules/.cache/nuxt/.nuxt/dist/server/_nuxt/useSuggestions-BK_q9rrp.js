import { u as useSupabaseClient } from "./useSupabaseClient-H06rCZGb.js";
import { ref } from "vue";
import { f as useSupabaseUser } from "../server.mjs";
function useSuggestions() {
  const supabase = useSupabaseClient();
  const suggestions = ref([]);
  const lastId = ref(null);
  const hasMore = ref(true);
  const loading = ref(false);
  const loadMore = async (filters = {}) => {
    if (loading.value || !hasMore.value) return;
    loading.value = true;
    try {
      let query = supabase.from("suggestions").select(`
          *,
          politicians!politician_id (id, name, region, party)
        `).order("id", { ascending: false }).limit(20);
      if (lastId.value) {
        query = query.lt("id", lastId.value);
      }
      if (filters.politician_id) {
        query = query.eq("politician_id", filters.politician_id);
      }
      if (filters.category) {
        query = query.eq("category", filters.category);
      }
      const { data: suggestionData, error } = await query;
      if (error) throw error;
      if (suggestionData && suggestionData.length > 0) {
        const userIds = [...new Set(suggestionData.map((s) => s.user_id))];
        const { data: profilesData, error: profilesError } = await supabase.from("profiles").select("id, nickname, region").in("id", userIds);
        if (profilesError) {
          console.error("Failed to fetch profiles for list:", profilesError);
        }
        const profilesMap = new Map(profilesData?.map((p) => [p.id, p]));
        const combinedData = suggestionData.map((suggestion) => ({
          ...suggestion,
          profiles: profilesMap.get(suggestion.user_id) || null
        }));
        suggestions.value.push(...combinedData);
        lastId.value = suggestionData[suggestionData.length - 1].id;
        hasMore.value = suggestionData.length === 20;
      } else {
        hasMore.value = false;
      }
    } catch (error) {
      console.error("Failed to load suggestions:", error);
    } finally {
      loading.value = false;
    }
  };
  const reset = () => {
    suggestions.value = [];
    lastId.value = null;
    hasMore.value = true;
  };
  const getSuggestion = async (id) => {
    try {
      const { data: suggestionData, error: suggestionError } = await supabase.from("suggestions").select(`
          *,
          politicians!politician_id (id, name, region, party)
        `).eq("id", id).single();
      if (suggestionError) throw suggestionError;
      if (!suggestionData) return { data: null, error: new Error("Suggestion not found") };
      const { data: profileData, error: profileError } = await supabase.from("profiles").select("id, nickname, region").eq("id", suggestionData.user_id).single();
      if (profileError) {
        console.error("Failed to fetch profile for suggestion:", profileError);
      }
      const combinedData = {
        ...suggestionData,
        profiles: profileData || null
      };
      await supabase.rpc("increment_suggestion_view_count", { suggestion_id: id });
      return { data: combinedData, error: null };
    } catch (error) {
      console.error("Failed to get suggestion:", error);
      return { data: null, error: error.message };
    }
  };
  const createSuggestion = async (suggestion) => {
    try {
      const user = useSupabaseUser();
      if (!user.value) {
        throw new Error("로그인이 필요합니다");
      }
      const userId = user.value.id || user.value.sub;
      const insertData = {
        ...suggestion,
        user_id: userId
      };
      const { data: newSuggestion, error: insertError } = await supabase.from("suggestions").insert([insertData]).select("id").single();
      if (insertError) throw insertError;
      if (!newSuggestion) throw new Error("Failed to get new suggestion ID");
      return await getSuggestion(newSuggestion.id);
    } catch (error) {
      console.error("Failed to create suggestion:", error);
      return { data: null, error: error.message };
    }
  };
  const updateSuggestion = async (id, updates) => {
    try {
      const { data, error } = await supabase.from("suggestions").update(updates).eq("id", id).select().single();
      if (error) throw error;
      return { data, error: null };
    } catch (error) {
      console.error("Failed to update suggestion:", error);
      return { data: null, error: error.message };
    }
  };
  const deleteSuggestion = async (id) => {
    try {
      const { error } = await supabase.from("suggestions").delete().eq("id", id);
      if (error) throw error;
      return { error: null };
    } catch (error) {
      console.error("Failed to delete suggestion:", error);
      return { error: error.message };
    }
  };
  return {
    suggestions,
    hasMore,
    loading,
    loadMore,
    reset,
    getSuggestion,
    createSuggestion,
    updateSuggestion,
    deleteSuggestion
  };
}
export {
  useSuggestions as u
};
//# sourceMappingURL=useSuggestions-BK_q9rrp.js.map
