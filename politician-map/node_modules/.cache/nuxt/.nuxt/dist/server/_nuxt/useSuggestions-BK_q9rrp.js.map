{"version":3,"file":"useSuggestions-BK_q9rrp.js","sources":["../../../../../../../composables/useSuggestions.ts"],"sourcesContent":["export function useSuggestions() {\n  const supabase = useSupabaseClient()\n  const suggestions = ref<any[]>([])\n  const lastId = ref<number | null>(null)\n  const hasMore = ref(true)\n  const loading = ref(false)\n\n  // 커서 기반 무한 스크롤로 건의사항 목록 로드\n  const loadMore = async (filters: { politician_id?: number; category?: string } = {}) => {\n    // 중복 요청 방지\n    if (loading.value || !hasMore.value) return\n\n    loading.value = true\n    try {\n      let query = supabase\n        .from('suggestions')\n        .select(`\n          *,\n          politicians!politician_id (id, name, region, party)\n        `)\n        .order('id', { ascending: false })\n        .limit(20)\n\n      // 커서 기반: lastId보다 작은 ID만 조회\n      if (lastId.value) {\n        query = query.lt('id', lastId.value)\n      }\n\n      // 필터 적용\n      if (filters.politician_id) {\n        query = query.eq('politician_id', filters.politician_id)\n      }\n      if (filters.category) {\n        query = query.eq('category', filters.category)\n      }\n\n      const { data: suggestionData, error } = await query\n\n      if (error) throw error\n\n      if (suggestionData && suggestionData.length > 0) {\n        // 2. Extract user IDs\n        const userIds = [...new Set(suggestionData.map(s => s.user_id))]\n\n        // 3. Fetch corresponding profiles in a single query\n        const { data: profilesData, error: profilesError } = await supabase\n          .from('profiles')\n          .select('id, nickname, region')\n          .in('id', userIds)\n\n        if (profilesError) {\n          console.error('Failed to fetch profiles for list:', profilesError)\n        }\n\n        // 4. Create a lookup map for profiles\n        const profilesMap = new Map(profilesData?.map(p => [p.id, p]))\n\n        // 5. Combine suggestions with their profiles\n        const combinedData = suggestionData.map(suggestion => ({\n          ...suggestion,\n          profiles: profilesMap.get(suggestion.user_id) || null\n        }))\n\n        suggestions.value.push(...combinedData)\n        lastId.value = suggestionData[suggestionData.length - 1].id\n        hasMore.value = suggestionData.length === 20 // 20개 미만이면 더 이상 없음\n      } else {\n        hasMore.value = false\n      }\n    } catch (error: any) {\n      console.error('Failed to load suggestions:', error)\n    } finally {\n      loading.value = false\n    }\n  }\n\n  // 목록 초기화 (필터 변경 시)\n  const reset = () => {\n    suggestions.value = []\n    lastId.value = null\n    hasMore.value = true\n  }\n\n  // 건의사항 상세 조회\n  const getSuggestion = async (id: number) => {\n    try {\n      // 1. Fetch suggestion and politician data (this join works)\n      const { data: suggestionData, error: suggestionError } = await supabase\n        .from('suggestions')\n        .select(`\n          *,\n          politicians!politician_id (id, name, region, party)\n        `)\n        .eq('id', id)\n        .single()\n\n      if (suggestionError) throw suggestionError\n      if (!suggestionData) return { data: null, error: new Error('Suggestion not found') }\n\n      // 2. Fetch profile data separately\n      const { data: profileData, error: profileError } = await supabase\n        .from('profiles')\n        .select('id, nickname, region')\n        .eq('id', suggestionData.user_id)\n        .single()\n\n      if (profileError) {\n        // It's better to log the error but still return the suggestion\n        console.error('Failed to fetch profile for suggestion:', profileError)\n      }\n\n      // 3. Combine the data\n      const combinedData = {\n        ...suggestionData,\n        profiles: profileData || null\n      }\n\n      // 조회수 증가\n      await supabase.rpc('increment_suggestion_view_count', { suggestion_id: id })\n\n      return { data: combinedData, error: null }\n    } catch (error: any) {\n      console.error('Failed to get suggestion:', error)\n      return { data: null, error: error.message }\n    }\n  }\n\n  // 건의사항 작성\n  const createSuggestion = async (suggestion: {\n    title: string\n    content: string\n    category: string\n    politician_id: number\n  }) => {\n    try {\n      const user = useSupabaseUser()\n\n      if (!user.value) {\n        throw new Error('로그인이 필요합니다')\n      }\n\n      // Supabase user 객체에서 ID는 id 또는 sub 필드에 있을 수 있음\n      const userId = user.value.id || user.value.sub\n\n      const insertData = {\n        ...suggestion,\n        user_id: userId\n      }\n\n      // 1. 먼저 건의사항을 삽입하고 새로 생성된 id만 가져옵니다.\n      const { data: newSuggestion, error: insertError } = await supabase\n        .from('suggestions')\n        .insert([insertData])\n        .select('id')\n        .single()\n\n      if (insertError) throw insertError\n      if (!newSuggestion) throw new Error('Failed to get new suggestion ID')\n\n      // 2. getSuggestion 함수를 사용해 전체 데이터를 다시 조회합니다.\n      // 이 함수는 조인이 정상적으로 작동하는 것으로 확인되었습니다.\n      return await getSuggestion(newSuggestion.id)\n    } catch (error: any) {\n      console.error('Failed to create suggestion:', error)\n      return { data: null, error: error.message }\n    }\n  }\n\n  // 건의사항 수정\n  const updateSuggestion = async (id: number, updates: {\n    title?: string\n    content?: string\n    category?: string\n    politician_id?: number\n  }) => {\n    try {\n      const { data, error } = await supabase\n        .from('suggestions')\n        .update(updates)\n        .eq('id', id)\n        .select()\n        .single()\n\n      if (error) throw error\n      return { data, error: null }\n    } catch (error: any) {\n      console.error('Failed to update suggestion:', error)\n      return { data: null, error: error.message }\n    }\n  }\n\n  // 건의사항 삭제\n  const deleteSuggestion = async (id: number) => {\n    try {\n      const { error } = await supabase\n        .from('suggestions')\n        .delete()\n        .eq('id', id)\n\n      if (error) throw error\n      return { error: null }\n    } catch (error: any) {\n      console.error('Failed to delete suggestion:', error)\n      return { error: error.message }\n    }\n  }\n\n  return {\n    suggestions,\n    hasMore,\n    loading,\n    loadMore,\n    reset,\n    getSuggestion,\n    createSuggestion,\n    updateSuggestion,\n    deleteSuggestion\n  }\n}\n"],"names":[],"mappings":"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"}