import{u as y}from"./DP_pfCD1.js";import{r as c,X as S}from"./CmVufc-E.js";function b(){const s=y(),d=c([]),u=c(null),l=c(!0),g=c(!1),m=async(t={})=>{if(!(g.value||!l.value)){g.value=!0;try{let e=s.from("suggestions").select(`
          *,
          politicians!politician_id (id, name, region, party)
        `).order("id",{ascending:!1}).limit(20);u.value&&(e=e.lt("id",u.value)),t.politician_id&&(e=e.eq("politician_id",t.politician_id)),t.category&&(e=e.eq("category",t.category));const{data:r,error:o}=await e;if(o)throw o;if(r&&r.length>0){const a=[...new Set(r.map(i=>i.user_id))],{data:n,error:p}=await s.from("profiles").select("id, nickname, region").in("id",a);p&&console.error("Failed to fetch profiles for list:",p);const h=new Map(n?.map(i=>[i.id,i])),v=r.map(i=>({...i,profiles:h.get(i.user_id)||null}));d.value.push(...v),u.value=r[r.length-1].id,l.value=r.length===20}else l.value=!1}catch(e){console.error("Failed to load suggestions:",e)}finally{g.value=!1}}},w=()=>{d.value=[],u.value=null,l.value=!0},f=async t=>{try{const{data:e,error:r}=await s.from("suggestions").select(`
          *,
          politicians!politician_id (id, name, region, party)
        `).eq("id",t).single();if(r)throw r;if(!e)return{data:null,error:new Error("Suggestion not found")};const{data:o,error:a}=await s.from("profiles").select("id, nickname, region").eq("id",e.user_id).single();a&&console.error("Failed to fetch profile for suggestion:",a);const n={...e,profiles:o||null};return await s.rpc("increment_suggestion_view_count",{suggestion_id:t}),{data:n,error:null}}catch(e){return console.error("Failed to get suggestion:",e),{data:null,error:e.message}}};return{suggestions:d,hasMore:l,loading:g,loadMore:m,reset:w,getSuggestion:f,createSuggestion:async t=>{try{const e=S();if(!e.value)throw new Error("로그인이 필요합니다");const r=e.value.id||e.value.sub,o={...t,user_id:r},{data:a,error:n}=await s.from("suggestions").insert([o]).select("id").single();if(n)throw n;if(!a)throw new Error("Failed to get new suggestion ID");return await f(a.id)}catch(e){return console.error("Failed to create suggestion:",e),{data:null,error:e.message}}},updateSuggestion:async(t,e)=>{try{const{data:r,error:o}=await s.from("suggestions").update(e).eq("id",t).select().single();if(o)throw o;return{data:r,error:null}}catch(r){return console.error("Failed to update suggestion:",r),{data:null,error:r.message}}},deleteSuggestion:async t=>{try{const{error:e}=await s.from("suggestions").delete().eq("id",t);if(e)throw e;return{error:null}}catch(e){return console.error("Failed to delete suggestion:",e),{error:e.message}}}}}export{b as u};
